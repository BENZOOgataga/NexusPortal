name: nexus-horizon-dev
include:
  - docker-compose.yml

services:
  db:
    ports: !override
      - "5433:5432"

  web:
    environment:
      BETTER_AUTH_URL: ${BETTER_AUTH_URL:-http://localhost:31882}
    ports: !override
      - "31882:3001"
    command: >
      sh -lc "
      apt-get update -y &&
      apt-get install -y --no-install-recommends openssl ca-certificates &&
      rm -rf /var/lib/apt/lists/* &&
      corepack enable &&
      corepack prepare pnpm@9.1.0 --activate &&
      pnpm install --frozen-lockfile &&
      pnpm -C packages/db db:push &&
      pnpm -C packages/db db:generate &&
      pnpm -C apps/web dev --hostname 0.0.0.0 --port 3001
      "
    volumes: !override
      - ./:/workspace
      - dev_node_modules:/workspace/node_modules
      - dev_pnpm_store:/root/.local/share/pnpm/store
      - dev_next_cache:/workspace/apps/web/.next

volumes:
  dev_node_modules:
  dev_pnpm_store:
  dev_next_cache:
